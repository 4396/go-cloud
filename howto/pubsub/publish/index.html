<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.54.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Publish Messages to a Topic &middot; Go CDK</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Source+Code+Pro|Work+Sans:400,700">
  <link type="text/css" rel="stylesheet" href="/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="/css/style.css">
  <link rel="shortcut icon" href="/favicon-32x32.png">
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-135118641-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div class="PageLayout">
    <header class="PageHeader">
      <a href="https://gocloud.dev/"><h1 class="PageLogo"><img class="PageLogo-image" src="/go-cdk-logo-white.png" alt="Go CDK"></h1></a>
    </header>
    <main class="MainContent">
      <div class="MainContent-bounds"><h1>Publish Messages to a Topic</h1>
<p>Publishing a message to a topic with the Go CDK takes two steps:</p>

<ol>
<li>Open the topic with the Pub/Sub provider of your choice (once per topic).</li>
<li>Send messages on the topic.</li>
</ol>

<p>The second step is the same across all providers because the first step
creates a value of the portable <a href="https://godoc.org/gocloud.dev/pubsub#Topic"><code>*pubsub.Topic</code></a> type. Publishing looks
like this:</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pubsub</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
	<span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;Hello, World!\n&#34;</span><span class="p">),</span>
	<span class="nx">Metadata</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
		<span class="c1">// These are examples of metadata.
</span><span class="c1"></span>		<span class="c1">// There is nothing special about the key names.
</span><span class="c1"></span>		<span class="s">&#34;language&#34;</span><span class="p">:</span>   <span class="s">&#34;en&#34;</span><span class="p">,</span>
		<span class="s">&#34;importance&#34;</span><span class="p">:</span> <span class="s">&#34;high&#34;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div>

<p>Note that the [semantics of message delivery][] can vary by provider.</p>

<p>The rest of this guide will discuss how to accomplish the first step: opening
a topic for your chosen Pub/Sub provider.</p>

<p>[semantics of message delivery][<a href="https://godoc.org/gocloud.dev/pubsub#hdr-At_most_once_and_At_least_once_Delivery">https://godoc.org/gocloud.dev/pubsub#hdr-At_most_once_and_At_least_once_Delivery</a>]</p>

<h2 id="constructors-versus-url-openers"> Constructors versus URL openers<a class="anchor" href="#constructors-versus-url-openers" aria-label="Link to Section">ðŸ”—</a></h2>

<p>If you know that your program is always going to use a particular Pub/Sub
provider or you need fine-grained control over the connection settings, you
should call the constructor function in the driver package directly (like
<code>gcppubsub.OpenTopic</code>). However, if you want to change providers based on
configuration, you can use <code>pubsub.OpenTopic</code>, making sure you <a href="https://golang.org/doc/effective_go.html#blank_import">&ldquo;blank
import&rdquo;</a> the driver package to link it in. See the
<a href="https://gocloud.dev/concepts/urls/">documentation on URLs</a> for more details. This guide will show how to use
both forms for each pub/sub provider.</p>

<h2 id="sns"> Amazon Simple Notification Service<a class="anchor" href="#sns" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to an Amazon <a href="https://aws.amazon.com/sns/">Simple Notification Service</a> (SNS)
topic. SNS URLs in the Go CDK use the Amazon Resource Name (ARN) to identify
the topic. You can specify the <code>region</code> query parameter to ensure your
application connects to the correct region, but otherwise <code>pubsub.OpenTopic</code>
will use the region found in the environment variables or your AWS CLI
configuration.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/awssnssqs&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">topicARN</span> <span class="p">=</span> <span class="s">&#34;arn:aws:sns:us-east-2:123456789012:mytopic&#34;</span>
<span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;awssns://&#34;</span><span class="o">+</span><span class="nx">topicARN</span><span class="o">+</span><span class="s">&#34;?region=us-east-2&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<p>SNS messages are restricted to UTF-8 clean payloads. If your application
sends a message that contains non-UTF-8 bytes, then the Go CDK will
automatically <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encode the message and add a <code>base64encoded</code> message
attribute. When subscribing to messages on the topic through the Go CDK,
these will be <a href="/howto/pubsub/subscribe/#sqs">automatically Base64 decoded</a>, but if you are
receiving messages from a topic in a program that does not use the Go CDK,
you may need to manually Base64 decode the message payload.</p>

<h3 id="sns-ctor"> Amazon Simple Notification Service Constructor<a class="anchor" href="#sns-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/awssnssqs#OpenSNSTopic"><code>awssnssqs.OpenSNSTopic</code></a> constructor opens an SNS topic. You must first
create an <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/session/">AWS session</a> with the same region as your topic:</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;github.com/aws/aws-sdk-go/aws&#34;</span>
	<span class="s">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
	<span class="s">&#34;gocloud.dev/pubsub/awssnssqs&#34;</span>
<span class="p">)</span>

<span class="c1">// Establish an AWS session.
</span><span class="c1">// See https://docs.aws.amazon.com/sdk-for-go/api/aws/session/ for more info.
</span><span class="c1">// The region must match the region for the SNS topic &#34;mytopic&#34;.
</span><span class="c1"></span><span class="nx">sess</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">aws</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
	<span class="nx">Region</span><span class="p">:</span> <span class="nx">aws</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;us-east-2&#34;</span><span class="p">),</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Create a *pubsub.Topic.
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">topicARN</span> <span class="p">=</span> <span class="s">&#34;arn:aws:sns:us-east-2:123456789012:mytopic&#34;</span>
<span class="nx">topic</span> <span class="o">:=</span> <span class="nx">awssnssqs</span><span class="p">.</span><span class="nf">OpenSNSTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sess</span><span class="p">,</span> <span class="nx">topicARN</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="sqs"> Amazon Simple Notification Service<a class="anchor" href="#sqs" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to an Amazon <a href="https://aws.amazon.com/sqs/">Simple Queue Service</a> (SQS)
topic. SQS URLs closely resemble the the queue URL, except the leading
<code>https://</code> is replaced with <code>awssqs://</code>. You can specify the <code>region</code>
query parameter to ensure your application connects to the correct region, but
otherwise <code>pubsub.OpenTopic</code> will use the region found in the environment
variables or your AWS CLI configuration.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/awssnssqs&#34;</span>
<span class="p">)</span>

<span class="c1">// https://docs.aws.amazon.com/sdk-for-net/v2/developer-guide/QueueURL.html
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">queueURL</span> <span class="p">=</span> <span class="s">&#34;https://sqs.us-east-2.amazonaws.com/123456789012/myqueue&#34;</span>
<span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;awssqs://&#34;</span><span class="o">+</span><span class="nx">queueURL</span><span class="o">+</span><span class="s">&#34;?region=us-east-2&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<p>SQS messages are restricted to UTF-8 clean payloads. If your application
sends a message that contains non-UTF-8 bytes, then the Go CDK will
automatically <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encode the message and add a <code>base64encoded</code> message
attribute. When subscribing to messages on the topic through the Go CDK,
these will be <a href="/howto/pubsub/subscribe/#sqs">automatically Base64 decoded</a>, but if you are
receiving messages from a topic in a program that does not use the Go CDK,
you may need to manually Base64 decode the message payload.</p>

<h3 id="sqs-ctor"> Amazon Simple Queue Service Constructor<a class="anchor" href="#sqs-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/awssnssqs#OpenSQSTopic"><code>awssnssqs.OpenSQSTopic</code></a> constructor opens an SQS topic. You must first
create an <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/session/">AWS session</a> with the same region as your topic:</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;github.com/aws/aws-sdk-go/aws&#34;</span>
	<span class="s">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
	<span class="s">&#34;gocloud.dev/pubsub/awssnssqs&#34;</span>
<span class="p">)</span>

<span class="c1">// Establish an AWS session.
</span><span class="c1">// See https://docs.aws.amazon.com/sdk-for-go/api/aws/session/ for more info.
</span><span class="c1">// The region must match the region for the SQS queue &#34;myqueue&#34;.
</span><span class="c1"></span><span class="nx">sess</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">aws</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
	<span class="nx">Region</span><span class="p">:</span> <span class="nx">aws</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;us-east-2&#34;</span><span class="p">),</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Create a *pubsub.Topic.
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">queueURL</span> <span class="p">=</span> <span class="s">&#34;https://sqs.us-east-2.amazonaws.com/123456789012/myqueue&#34;</span>
<span class="nx">topic</span> <span class="o">:=</span> <span class="nx">awssnssqs</span><span class="p">.</span><span class="nf">OpenSQSTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sess</span><span class="p">,</span> <span class="nx">queueURL</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="gcp"> Google Cloud Pub/Sub<a class="anchor" href="#gcp" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to a Google <a href="https://cloud.google.com/pubsub/docs/">Cloud Pub/Sub</a> topic. The URLs use the
project ID and the topic ID. <code>pubsub.OpenTopic</code> will use <a href="https://cloud.google.com/docs/authentication/production">Application Default
Credentials</a>.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/gcppubsub&#34;</span>
<span class="p">)</span>

<span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;gcppubsub://myproject/mytopic&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h3 id="gcp-ctor"> Google Cloud Pub/Sub Constructor<a class="anchor" href="#gcp-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/gcppubsub#OpenTopic"><code>gcppubsub.OpenTopic</code></a> constructor opens a Cloud Pub/Sub topic. You
must first obtain <a href="https://cloud.google.com/docs/authentication/production">GCP credentials</a> and then create a gRPC
connection to Cloud Pub/Sub. (This gRPC connection can be reused among
topics.)</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/gcp&#34;</span>
	<span class="s">&#34;gocloud.dev/pubsub/gcppubsub&#34;</span>
<span class="p">)</span>

<span class="c1">// Your GCP credentials.
</span><span class="c1">// See https://cloud.google.com/docs/authentication/production
</span><span class="c1">// for more info on alternatives.
</span><span class="c1"></span><span class="nx">creds</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gcp</span><span class="p">.</span><span class="nf">DefaultCredentials</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="c1">// Get the project ID from the credentials (required by OpenTopic).
</span><span class="c1"></span><span class="nx">projectID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gcp</span><span class="p">.</span><span class="nf">DefaultProjectID</span><span class="p">(</span><span class="nx">creds</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="c1">// Open a gRPC connection to the GCP Pub/Sub API.
</span><span class="c1"></span><span class="nx">conn</span><span class="p">,</span> <span class="nx">cleanup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gcppubsub</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">creds</span><span class="p">.</span><span class="nx">TokenSource</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>

<span class="c1">// Construct a PublisherClient using the connection.
</span><span class="c1"></span><span class="nx">pubClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gcppubsub</span><span class="p">.</span><span class="nf">PublisherClient</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">pubClient</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="c1">// Construct a *pubsub.Topic.
</span><span class="c1"></span><span class="nx">topic</span> <span class="o">:=</span> <span class="nx">gcppubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">pubClient</span><span class="p">,</span> <span class="nx">projectID</span><span class="p">,</span> <span class="s">&#34;example-topic&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="azure"> Azure Service Bus<a class="anchor" href="#azure" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to an <a href="https://azure.microsoft.com/en-us/services/service-bus/">Azure Service Bus</a> topic over <a href="https://www.amqp.org/">AMQP 1.0</a>.
The URL for publishing is the topic name. <code>pubsub.OpenTopic</code> will use the
environment variable <code>SERVICEBUS_CONNECTION_STRING</code> to obtain the Service Bus
connection string. The connection string can be obtained
<a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions#get-the-connection-string">from the Azure portal</a>.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/azuresb&#34;</span>
<span class="p">)</span>

<span class="c1">// pubsub.OpenTopic creates a *pubsub.Topic from a URL.
</span><span class="c1">// This URL will open the topic &#34;mytopic&#34; using a connection string
</span><span class="c1">// from the environment variable SERVICEBUS_CONNECTION_STRING.
</span><span class="c1"></span><span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;azuresb://mytopic&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h3 id="azure-ctor"> Azure Service Bus Constructor<a class="anchor" href="#azure-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/azuresb#OpenTopic"><code>azuresb.OpenTopic</code></a> constructor opens an Azure Service Bus topic. You
must first connect to the topic using the <a href="https://github.com/Azure/azure-service-bus-go">Azure Service Bus library</a> and
then pass it to <code>azuresb.OpenTopic</code>. There are also helper functions in the
<code>azuresb</code> package to make this easier.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;os&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub/azuresb&#34;</span>
<span class="p">)</span>

<span class="c1">// Change these as needed for your application.
</span><span class="c1"></span><span class="nx">connString</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;SERVICEBUS_CONNECTION_STRING&#34;</span><span class="p">)</span>
<span class="nx">topicName</span> <span class="o">:=</span> <span class="s">&#34;test-topic&#34;</span>

<span class="k">if</span> <span class="nx">connString</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;Service Bus ConnectionString is not set&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Connect to Azure Service Bus for the given topic.
</span><span class="c1"></span><span class="nx">busNamespace</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">azuresb</span><span class="p">.</span><span class="nf">NewNamespaceFromConnectionString</span><span class="p">(</span><span class="nx">connString</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="nx">busTopic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">azuresb</span><span class="p">.</span><span class="nf">NewTopic</span><span class="p">(</span><span class="nx">busNamespace</span><span class="p">,</span> <span class="nx">topicName</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">busTopic</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

<span class="c1">// Construct a *pubsub.Topic.
</span><span class="c1"></span><span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">azuresb</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">busTopic</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="rabbitmq"> RabbitMQ<a class="anchor" href="#rabbitmq" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to an <a href="https://www.rabbitmq.com/protocol.html">AMQP 0.9.1</a> fanout exchange, the dialect of
AMQP spoken by <a href="https://www.rabbitmq.com">RabbitMQ</a>. A RabbitMQ URL only includes the exchange name.
The RabbitMQ&rsquo;s server is discovered from the <code>RABBIT_SERVER_URL</code> environment
variable (which is something like <code>amqp://guest:guest@localhost:5672/</code>).</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/rabbitpubsub&#34;</span>
<span class="p">)</span>

<span class="c1">// pubsub.OpenTopic creates a *pubsub.Topic from a URL.
</span><span class="c1">// This URL will Dial the RabbitMQ server at the URL in the environment
</span><span class="c1">// variable RABBIT_SERVER_URL and open the exchange &#34;myexchange&#34;.
</span><span class="c1"></span><span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;rabbit://myexchange&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h3 id="rabbitmq-ctor"> RabbitMQ Constructor<a class="anchor" href="#rabbitmq-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/rabbitpubsub#OpenTopic"><code>rabbitpubsub.OpenTopic</code></a> constructor opens a RabbitMQ exchange. You
must first create an <a href="https://godoc.org/github.com/streadway/amqp#Connection"><code>*amqp.Connection</code></a> to your RabbitMQ instance.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;github.com/streadway/amqp&#34;</span>
	<span class="s">&#34;gocloud.dev/pubsub/rabbitpubsub&#34;</span>
<span class="p">)</span>

<span class="nx">rabbitConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">amqp</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="s">&#34;amqp://guest:guest@localhost:5672/&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">rabbitConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="nx">topic</span> <span class="o">:=</span> <span class="nx">rabbitpubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">rabbitConn</span><span class="p">,</span> <span class="s">&#34;myexchange&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="nats"> NATS<a class="anchor" href="#nats" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to a <a href="https://nats.io/">NATS</a> subject. A NATS URL only includes the
subject name. The NATS server is discovered from the <code>NATS_SERVER_URL</code>
environment variable (which is something like <code>nats://nats.example.com</code>).</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/natspubsub&#34;</span>
<span class="p">)</span>

<span class="c1">// pubsub.OpenTopic creates a *pubsub.Topic from a URL.
</span><span class="c1">// This URL will Dial the NATS server at the URL in the environment variable
</span><span class="c1">// NATS_SERVER_URL and send messages with subject &#34;example.mysubject&#34;.
</span><span class="c1"></span><span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;nats://example.mysubject&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<p>Because NATS does not natively support metadata, messages sent to NATS will
be encoded with <a href="https://golang.org/pkg/encoding/gob/">gob</a>.</p>

<h3 id="nats-ctor"> NATS Constructor<a class="anchor" href="#nats-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/natspubsub#OpenTopic"><code>natspubsub.OpenTopic</code></a> constructor opens a NATS subject as a topic. You
must first create an <a href="https://godoc.org/github.com/nats-io/go-nats#Conn"><code>*nats.Conn</code></a> to your NATS instance.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;github.com/nats-io/go-nats&#34;</span>
	<span class="s">&#34;gocloud.dev/pubsub/natspubsub&#34;</span>
<span class="p">)</span>

<span class="nx">natsConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">nats</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="s">&#34;nats://nats.example.com&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">natsConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">natspubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">natsConn</span><span class="p">,</span> <span class="s">&#34;example.mysubject&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="kafka"> Kafka<a class="anchor" href="#kafka" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK can publish to a <a href="https://kafka.apache.org/">Kafka</a> cluster. A Kafka URL only includes the
topic name. The brokers in the Kafka cluster are discovered from the
<code>KAFKA_BROKERS</code> environment variable (which is a comma-delimited list of
hosts, something like <code>1.2.3.4:9092,5.6.7.8:9092</code>).</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/kafkapubsub&#34;</span>
<span class="p">)</span>

<span class="c1">// pubsub.OpenTopic creates a *pubsub.Topic from a URL.
</span><span class="c1">// The host + path are the topic name to send to.
</span><span class="c1">// The set of brokers must be in an environment variable KAFKA_BROKERS.
</span><span class="c1"></span><span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;kafka://my-topic&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h3 id="kafka-ctor"> Kafka Constructor<a class="anchor" href="#kafka-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>The <a href="https://godoc.org/gocloud.dev/pubsub/kafkapubsub#OpenTopic"><code>kafkapubsub.OpenTopic</code></a> constructor opens a Kafka topic to publish
messages to. Depending on your Kafka cluster configuration (see
<code>auto.create.topics.enable</code>), you may need to provision the topic beforehand.</p>

<p>In addition to the list of brokers, you&rsquo;ll need a <a href="https://godoc.org/github.com/Shopify/sarama#Config"><code>*sarama.Config</code></a>, which
exposes many knobs that can affect performance and semantics; review and set
them carefully. <a href="https://godoc.org/gocloud.dev/pubsub/kafkapubsub#MinimalConfig"><code>kafkapubsub.MinimalConfig</code></a> provides a minimal config to get
you started.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub/kafkapubsub&#34;</span>
<span class="p">)</span>

<span class="c1">// The set of brokers in the Kafka cluster.
</span><span class="c1"></span><span class="nx">addrs</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;1.2.3.4:9092&#34;</span><span class="p">}</span>
<span class="c1">// The Kafka client configuration to use.
</span><span class="c1"></span><span class="nx">config</span> <span class="o">:=</span> <span class="nx">kafkapubsub</span><span class="p">.</span><span class="nf">MinimalConfig</span><span class="p">()</span>

<span class="c1">// Construct a *pubsub.Topic.
</span><span class="c1"></span><span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kafkapubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">addrs</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="s">&#34;my-topic&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h2 id="mem"> In-Memory<a class="anchor" href="#mem" aria-label="Link to Section">ðŸ”—</a></h2>

<p>The Go CDK includes an in-memory Pub/Sub provider useful for local testing.
The names in <code>mem://</code> URLs are a process-wide namespace, so subscriptions to
the same name will receive messages posted to that topic. This is detailed
more in the <a href="https://gocloud.dev/howto/pubsub/subscribe/#mem">subscription guide</a>.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/pubsub/mempubsub&#34;</span>
<span class="p">)</span>

<span class="nx">topic</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pubsub</span><span class="p">.</span><span class="nf">OpenTopic</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;mem://topicA&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div>

<h3 id="mem-ctor"> In-Memory Constructor<a class="anchor" href="#mem-ctor" aria-label="Link to Section">ðŸ”—</a></h3>

<p>To create an in-memory Pub/Sub topic, use the <a href="https://godoc.org/gocloud.dev/pubsub/mempubsub#NewTopic"><code>mempubsub.NewTopic</code>
function</a>. You can use the returned topic to create in-memory
subscriptions, as detailed in the <a href="https://gocloud.dev/howto/pubsub/subscribe/#mem-ctor">subscription guide</a>.</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/pubsub/mempubsub&#34;</span>
<span class="p">)</span>

<span class="nx">topic</span> <span class="o">:=</span> <span class="nx">mempubsub</span><span class="p">.</span><span class="nf">NewTopic</span><span class="p">()</span>
<span class="k">defer</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div></div>
    </main>
    <nav class="Sidenav">
      <ul class="Sidenav-list">
        <li class="Sidenav-section">
          <a href="/" class="Sidenav-sectionLink">Home</a>
        </li>
        <li class="Sidenav-section">
          <a href="/tutorials/" class="Sidenav-sectionLink">Tutorials</a>
            <ul class="Sidenav-pageList">
              <li class="Sidenav-page">
                <a href="/tutorials/cli-uploader/" class="Sidenav-pageLink">Command-Line Uploader</a>
              </li>
              <li class="Sidenav-page">
                <a href="/tutorials/deploy-aws/" class="Sidenav-pageLink">Deploy to AWS</a>
              </li>
              <li class="Sidenav-page">
                <a href="/tutorials/deploy-gcp/" class="Sidenav-pageLink">Deploy to GCP</a>
              </li>
              <li class="Sidenav-page">
                <a href="/tutorials/deploy-azure/" class="Sidenav-pageLink">Connect to Azure</a>
              </li>
              
            </ul>
        </li>
        <li class="Sidenav-section">
          <a href="/howto/" class="Sidenav-sectionLink">How-To Guides</a>
            <ul class="Sidenav-pageList">
              
              <li class="Sidenav-page">
                <a href="/howto/blob/" class="Sidenav-pageLink">Blob</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/pubsub/" class="Sidenav-pageLink">Pub/Sub</a>
              </li>
            </ul>
        </li>
        <li class="Sidenav-section">
          <a href="/ref/" class="Sidenav-sectionLink">Reference</a>
            <ul class="Sidenav-pageList">
              <li class="Sidenav-page">
                <a href="/ref/blob/" class="Sidenav-pageLink">Blob</a>
              </li>
              <li class="Sidenav-page">
                <a href="/ref/sql/" class="Sidenav-pageLink">MySQL/Postgres</a>
              </li>
              <li class="Sidenav-page">
                <a href="/ref/pubsub/" class="Sidenav-pageLink">Pubsub</a>
              </li>
              <li class="Sidenav-page">
                <a href="/ref/runtimevar/" class="Sidenav-pageLink">Runtimevar</a>
              </li>
              <li class="Sidenav-page">
                <a href="/ref/secrets/" class="Sidenav-pageLink">Secrets</a>
              </li>
              <li class="Sidenav-page">
                <a href="/ref/server/" class="Sidenav-pageLink">Server</a>
              </li>
              
            </ul>
        </li>
        <li class="Sidenav-section">
          <a href="/concepts/" class="Sidenav-sectionLink">Concepts</a>
            <ul class="Sidenav-pageList">
              <li class="Sidenav-page">
                <a href="/concepts/urls/" class="Sidenav-pageLink">URLs</a>
              </li>
              <li class="Sidenav-page">
                <a href="/concepts/as/" class="Sidenav-pageLink">Using provider-specific APIs</a>
              </li>
              
            </ul>
        </li>
      </ul>
    </nav>
    <footer class="PageFooter">
      <nav>
        <ul class="FooterLinks">
          <li class="FooterLinks-item"><a href="https://github.com/google/go-cloud/" class="FooterLinks-link">GitHub</a></li>
          <li class="FooterLinks-item"><a href="https://groups.google.com/forum/#!forum/go-cloud" class="FooterLinks-link">Google Groups</a></li>
          <li class="FooterLinks-item"><a href="mailto:go-cdk-feedback@google.com" class="FooterLinks-link">Contact Team</a></li>
        </ul>
      </nav>

      <p class="PageFooter-paragraph">
        Copyright Â© 2018â€“2019 The Go Cloud Development Kit Authors.
        All content released under an <a href="https://github.com/google/go-cloud/blob/master/LICENSE" target="_blank" class="PageFooter-link">Apache 2.0 License</a>.
      </p>
      <p class="PageFooter-paragraph"><a href="https://github.com/google/go-cloud/edit/master/internal/website/content/howto/pubsub/publish.md" class="PageFooter-link">Improve this page</a> on GitHub.</p>
    </footer>
  </div>
</body>
</html>
